"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const coverage_1 = require("../coverage");
jest.mock("fs-extra");
const fs = jest.mocked(fs_extra_1.default);
beforeEach(() => {
    jest.resetAllMocks();
    // @ts-expect-error
    fs.pathExists.mockResolvedValue(true);
    fs.pathExistsSync.mockReturnValue(true);
});
describe(".generateCoverageData()", () => {
    test("copies coverage files", async () => {
        fs.readFile.mockRejectedValue(Error());
        await expect((0, coverage_1.generateCoverageData)()).resolves.toBeUndefined();
        expect(fs.copy).toBeCalledWith(path_1.default.join("coverage"), expect.anything());
    });
    test("copies coverage files from specified directory", async () => {
        fs.readFile.mockRejectedValue(Error());
        await expect((0, coverage_1.generateCoverageData)({ coverageDir: "coverage2" })).resolves.toBeUndefined();
        expect(fs.copy).toBeCalledWith(path_1.default.join("coverage2"), expect.anything());
    });
    test("generates triples from clover", async () => {
        fs.readFile.mockResolvedValue(
        // @ts-expect-error
        '<metrics statements="34" coveredstatements="17" conditionals="24" coveredconditionals="18');
        await expect((0, coverage_1.generateCoverageData)()).resolves.toBeUndefined();
        expect(fs.outputFile).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples from cobertura", async () => {
        fs.readFile.mockRejectedValueOnce(Error()).mockResolvedValue(
        // @ts-expect-error
        '<coverage lines-valid="34" lines-covered="17" branches-valid="24" branches-covered="18');
        await expect((0, coverage_1.generateCoverageData)()).resolves.toBeUndefined();
        expect(fs.outputFile).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples from cobertura with variable spacing", async () => {
        fs.readFile.mockRejectedValueOnce(Error()).mockResolvedValue(
        // @ts-expect-error
        '<coverage lines-valid="34"  lines-covered="17"  branches-valid="24"  branches-covered="18');
        await expect((0, coverage_1.generateCoverageData)()).resolves.toBeUndefined();
        expect(fs.outputFile).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples from json-summary", async () => {
        fs.readFile
            .mockRejectedValueOnce(Error())
            .mockRejectedValueOnce(Error())
            .mockResolvedValue(
        // @ts-expect-error
        '{"total": {"lines":{"total":34,"covered":17,"skipped":0,"pct":100},"branches":{"total":24,"covered":18');
        await expect((0, coverage_1.generateCoverageData)()).resolves.toBeUndefined();
        expect(fs.outputFile).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples using specified language", async () => {
        fs.readFile.mockResolvedValue(
        // @ts-expect-error
        '<metrics statements="34" coveredstatements="17" conditionals="24" coveredconditionals="18');
        await expect((0, coverage_1.generateCoverageData)({ language: "typescript" })).resolves.toBeUndefined();
        expect(fs.outputFile).toBeCalledWith(expect.anything(), "typescript:line:50\ntypescript:branch:75\n", expect.anything());
    });
});
describe(".generateCoverageDataSync()", () => {
    test("copies coverage files from default directory", () => {
        fs.readFileSync.mockImplementation(() => {
            throw new Error();
        });
        expect((0, coverage_1.generateCoverageDataSync)()).toBeUndefined();
        expect(fs.copySync).toBeCalledWith(path_1.default.join("coverage"), expect.anything());
    });
    test("copies coverage files from default directory when undefined", () => {
        fs.readFileSync.mockImplementation(() => {
            throw new Error();
        });
        expect((0, coverage_1.generateCoverageDataSync)({ coverageDir: undefined })).toBeUndefined();
        expect(fs.copySync).toBeCalledWith(path_1.default.join("coverage"), expect.anything());
    });
    test("copies coverage files from specified directory", () => {
        fs.readFileSync.mockImplementation(() => {
            throw new Error();
        });
        expect((0, coverage_1.generateCoverageDataSync)({ coverageDir: "coverage2" })).toBeUndefined();
        expect(fs.copySync).toBeCalledWith(path_1.default.join("coverage2"), expect.anything());
    });
    test("generates triples from clover", () => {
        fs.readFileSync.mockReturnValue('<metrics statements="34" coveredstatements="17" conditionals="24" coveredconditionals="18');
        expect((0, coverage_1.generateCoverageDataSync)()).toBeUndefined();
        expect(fs.outputFileSync).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples from cobertura", () => {
        fs.readFileSync
            .mockImplementationOnce(() => {
            throw new Error();
        })
            .mockReturnValue('<coverage lines-valid="34" lines-covered="17" branches-valid="24" branches-covered="18');
        expect((0, coverage_1.generateCoverageDataSync)()).toBeUndefined();
        expect(fs.outputFileSync).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples from json-summary", () => {
        fs.readFileSync
            .mockImplementationOnce(() => {
            throw new Error();
        })
            .mockImplementationOnce(() => {
            throw new Error();
        })
            .mockReturnValue('{"total": {"lines":{"total":34,"covered":17,"skipped":0,"pct":100},"branches":{"total":24,"covered":18');
        expect((0, coverage_1.generateCoverageDataSync)()).toBeUndefined();
        expect(fs.outputFileSync).toBeCalledWith(expect.anything(), "javascript:line:50\njavascript:branch:75\n", expect.anything());
    });
    test("generates triples using specified language", () => {
        fs.readFileSync.mockReturnValue('<metrics statements="34" coveredstatements="17" conditionals="24" coveredconditionals="18');
        expect((0, coverage_1.generateCoverageDataSync)({ language: "typescript" })).toBeUndefined();
        expect(fs.outputFileSync).toBeCalledWith(expect.anything(), "typescript:line:50\ntypescript:branch:75\n", expect.anything());
    });
});
